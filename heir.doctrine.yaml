meta:
  app_name: "company-lifecycle-cl"
  repo_slug: "djb258/company-lifecycle-cl"
  stack:
    - "react"
    - "vite"
    - "typescript"
    - "neon"
    - "tailwindcss"
    - "shadcn-ui"
  llm:
    providers:
      - anthropic
      - openai
    default: "anthropic"

doctrine:
  unique_id: "HUB-CL-001-${TIMESTAMP}-${RANDOM_HEX}"
  process_id: "CL-CORE"
  schema_version: "HEIR/1.0"
  hub_name: "Company Lifecycle Hub"
  hub_id: "HUB-CL-001"
  altitude: "30k"
  ctb_path: "sys/company-lifecycle"
  owner: "Barton / Supreme Headquarters (SHQ)"

  # Sovereign Intake Engine Configuration
  intake_engine:
    version: "2.0.0"
    doctrine: "STATE_AS_DATA"
    description: |
      State-agnostic Sovereign Intake Engine.
      NC is Source Stream #001, not special.
      State is DATA, not CODE.
      All states use the same verification logic.
      Identity minting ONLY after VERIFIED status.

    # LOCKED INVARIANT
    invariant: |
      If any code path mints an identity without passing through
      cl.company_candidate → verifyCandidate(), the build is invalid.

    # Execution Path (SINGLE, CANONICAL)
    execution_path:
      - step: "ingest"
        cli: "pipeline/ingest.js --source <STATE> --file <PATH>"
        writes_to: "cl.company_candidate"
        mints_identity: false
      - step: "verify"
        cli: "pipeline/orchestrator.js --state <STATE>"
        reads_from: "cl.company_candidate"
        mints_identity: true
        guard: "assertVerificationComplete()"

    source_streams:
      NC_EXCEL_SS001:
        id: "SS-001"
        name: "NC Company Data (Excel/Clay)"
        state_code: "NC"
        adapter: "NCExcelSourceAdapter"
        status: "active"
      DE_CSV_SS002:
        id: "SS-002"
        name: "DE Company Data (Clay CSV)"
        state_code: "DE"
        adapter: "DECsvSourceAdapter"
        status: "active"
      # Future streams:
      # TX_CSV_SS003:
      #   id: "SS-003"
      #   name: "TX Company Data"
      #   state_code: "TX"
      #   adapter: "TXCsvSourceAdapter"
      #   status: "planned"

    admission_gate:
      rule: "company_domain IS NOT NULL OR linkedin_url IS NOT NULL"
      fail_action: "reject"

    verification:
      pipeline: "LifecycleWorker.verifyCandidate"
      state_agnostic: true
      guard: "assertVerificationComplete"
      rules:
        - "Admission gate (domain OR LinkedIn)"
        - "Company name required"
        - "Domain format validation"
        - "LinkedIn URL format validation"
        - "Generic email domain rejection"

    identity_minting:
      trigger: "verification_status = 'VERIFIED'"
      guard: "assertVerificationComplete(candidate, verificationResult)"
      dedup_keys:
        - company_domain
        - linkedin_company_url
      sovereign_id: "company_unique_id"

    deprecated:
      path: "deprecated/"
      reason: "Old NC-specific pipeline violated verification-before-minting invariant"
      files:
        - "nc-phases-b-f.js"
        - "nc-phase-a-validation.js"
        - "pass-2-name-canonicalization.js"
        - "pass-3-domain-coherence.js"
        - "pass-4-collision-detection.js"
        - "pass-5-firmographic-coherence.js"

  # ═══════════════════════════════════════════════════════════════
  # SUBHUB-CL-LCS — Lifecycle Communication Spine
  # ═══════════════════════════════════════════════════════════════
  lcs:
    subhub_id: "SUBHUB-CL-LCS"
    name: "Lifecycle Communication Spine"
    version: "2.2.0"
    status: "ACTIVE"
    altitude: "20k"
    ctb_path: "sys/lcs"
    schema: "lcs"
    description: |
      Canonical event ledger and communication orchestration engine
      for all lifecycle phases. 9-step IMO pipeline: Signal → Collect →
      Frame → Mint → Audience → Adapter → Log → Error.

    # Schema ownership — lcs schema is exclusively owned by this sub-hub
    schema_ownership:
      schema_name: "lcs"
      tables:
        - "lcs.event"
        - "lcs.err0"
        - "lcs.signal_queue"
        - "lcs.signal_registry"
        - "lcs.frame_registry"
        - "lcs.adapter_registry"
      views:
        - "lcs.v_latest_by_entity"
        - "lcs.v_latest_by_company"
        - "lcs.v_company_intelligence"
      functions:
        - "lcs.refresh_lcs_matview(TEXT)"
        - "lcs.bridge_pressure_signals()"
        - "lcs.prevent_comm_id_update()"  # trigger function

    # Dual-ID model
    id_model:
      communication_id:
        format: "LCS-{PHASE}-{YYYYMMDD}-{ULID}"
        strategy: "ULID"
        minted_by: "src/app/lcs/id-minter.ts"
        immutable: true
      message_run_id:
        format: "RUN-{COMM_ID}-{CHANNEL}-{ATTEMPT}"
        strategy: "structured"
        minted_by: "src/app/lcs/id-minter.ts"
        immutable: true

    # ORBT 3-strike error protocol
    orbt_protocol:
      version: "1.0.0"
      table: "lcs.err0"
      classification: "APPEND-ONLY"
      strikes:
        - strike: 1
          action: "AUTO_RETRY"
          description: "Same channel, automatic retry"
        - strike: 2
          action: "ALT_CHANNEL"
          description: "Try alternate delivery channel if eligible"
        - strike: 3
          action: "HUMAN_ESCALATION"
          description: "Route to human — system gives up"
      columns:
        - "orbt_strike_number"
        - "orbt_action_taken"
        - "orbt_alt_channel_eligible"
        - "orbt_alt_channel_reason"

    # Infrastructure gates (src/sys/lcs/gates/)
    gates:
      capacity_gate:
        path: "src/sys/lcs/gates/capacity-gate.ts"
        checks:
          - "founder_calendar_available"
          - "adapter_health_status"
          - "adapter_daily_cap"
          - "agent_territory_cap"
      suppression_engine:
        path: "src/sys/lcs/gates/suppression-engine.ts"
        state_machine: ["ACTIVE", "COOLED", "PARKED", "SUPPRESSED"]
        checks:
          - "never_contact"
          - "unsubscribed"
          - "hard_bounced"
          - "complained"
          - "frequency_cap"
          - "company_weekly_throttle"
      freshness_gate:
        path: "src/sys/lcs/gates/freshness-gate.ts"
        checks:
          - "people_stale_hard_block"
          - "other_subhub_stale_tier_downgrade"
          - "frame_required_fields_satisfaction"

    # Spokes — 6 ingress, 3 egress
    spokes:
      ingress:
        - spoke_id: "SPOKE-CL-I-010"
          name: "Outreach Signal Ingress"
          contract: "src/sys/lcs/contracts/spoke_i010_outreach_signal.ts"
        - spoke_id: "SPOKE-CL-I-011"
          name: "Sales Signal Ingress"
          contract: "src/sys/lcs/contracts/spoke_i011_sales_signal.ts"
        - spoke_id: "SPOKE-CL-I-012"
          name: "Client Signal Ingress"
          contract: "src/sys/lcs/contracts/spoke_i012_client_signal.ts"
        - spoke_id: "SPOKE-CL-I-013"
          name: "Calendly Webhook Ingress"
          contract: "src/sys/lcs/contracts/spoke_i013_calendly_webhook.ts"
        - spoke_id: "SPOKE-CL-I-014"
          name: "Reply Ingestion"
          contract: "src/sys/lcs/contracts/spoke_i014_reply_ingestion.ts"
        - spoke_id: "SPOKE-CL-I-015"
          name: "AFLAC Data Adapter"
          contract: "src/sys/lcs/contracts/spoke_i015_aflac_data.ts"
          status: "PENDING"
      egress:
        - spoke_id: "SPOKE-CL-O-010"
          name: "Mailgun Adapter"
          contract: "src/sys/lcs/contracts/spoke_o010_mailgun.ts"
        - spoke_id: "SPOKE-CL-O-011"
          name: "HeyReach Adapter"
          contract: "src/sys/lcs/contracts/spoke_o011_heyreach.ts"
        - spoke_id: "SPOKE-CL-O-012"
          name: "Sales Handoff"
          contract: "src/sys/lcs/contracts/spoke_o012_sales_handoff.ts"

    # Registries
    registries:
      signal_registry:
        table: "lcs.signal_registry"
        pk: "signal_set_hash"
        mutability: "CONFIG (INSERT/UPDATE, no DELETE — soft-deactivate via is_active)"
      frame_registry:
        table: "lcs.frame_registry"
        pk: "frame_id"
        mutability: "CONFIG (INSERT/UPDATE, no DELETE — soft-deactivate via is_active)"
      adapter_registry:
        table: "lcs.adapter_registry"
        pk: "adapter_type"
        mutability: "CONFIG (INSERT/UPDATE, no DELETE — soft-deactivate via is_active)"

    # Materialized view refresh schedule
    matview_refresh:
      v_company_intelligence:
        schedule: "Nightly 2:00 AM"
        method: "REFRESH MATERIALIZED VIEW CONCURRENTLY"
      v_latest_by_entity:
        schedule: "Nightly 2:30 AM"
        method: "REFRESH MATERIALIZED VIEW CONCURRENTLY"
      v_latest_by_company:
        schedule: "Nightly 2:30 AM"
        method: "REFRESH MATERIALIZED VIEW CONCURRENTLY"

    # IMO flow for LCS pipeline
    imo:
      ingress:
        - name: "Signal Spokes (I-010 thru I-015)"
          type: "spoke"
          description: "Outreach, Sales, Client signals, Calendly, Reply, AFLAC"
      middle:
        - name: "Capacity Gate"
          type: "gate"
          path: "src/sys/lcs/gates/capacity-gate.ts"
        - name: "Suppression Engine"
          type: "gate"
          path: "src/sys/lcs/gates/suppression-engine.ts"
        - name: "Freshness Gate"
          type: "gate"
          path: "src/sys/lcs/gates/freshness-gate.ts"
        - name: "LCS Pipeline (9-step)"
          type: "orchestrator"
          path: "src/app/lcs/"
        - name: "ID Minter"
          type: "service"
          path: "src/app/lcs/id-minter.ts"
      egress:
        - name: "Mailgun Adapter (O-010)"
          type: "spoke"
        - name: "HeyReach Adapter (O-011)"
          type: "spoke"
        - name: "Sales Handoff (O-012)"
          type: "spoke"
        - name: "CET (lcs.event)"
          type: "event"
          description: "Append-only canonical event table"

deliverables:
  repos:
    - name: "company-lifecycle-cl"
      visibility: private
      hub_type: "sovereign-authority"
  services:
    - name: "web"
      port: 5173
      description: "Vite development server"
    - name: "preview"
      port: 4173
      description: "Vite preview server"
  env:
    VITE_NEON_URL: "${DOPPLER:NEON_URL}"
    VITE_NEON_API_KEY: "${DOPPLER:NEON_API_KEY}"
    LLM_DEFAULT_PROVIDER: "anthropic"

contracts:
  acceptance:
    - "All HEIR checks pass in CI"
    - "Build succeeds without errors"
    - "Lint passes without errors"
    - "All tests pass"
    - "Hub compliance checklist verified"

build:
  actions:
    lint: ["npm run lint"]
    build: ["npm run build"]
    test: ["npm run test"]
    heir_check: ["npm run heir:check"]
  ci_checks:
    - "npm run lint"
    - "npm run build"
  telemetry_events:
    - "app.start"
    - "lifecycle.stage.promotion"
    - "company.identity.mint"
    - "subhub.activate"
    - "subhub.deactivate"

imo:
  ingress:
    - name: "Outreach App"
      type: "spoke"
      description: "Outreach events (activation, meeting set)"
    - name: "Sales App"
      type: "spoke"
      description: "Sales outcome events"
    - name: "Client App"
      type: "spoke"
      description: "Client activation confirmation"
  middle:
    - name: "Neon (Primary DB)"
      type: "database"
      doctrine_id: "DB-NEON-01"
    - name: "Event Validator"
      type: "validation"
      doctrine_id: "EVT-VALID-01"
  egress:
    - name: "Reporting"
      type: "spoke"
      description: "Read-only lifecycle state"
    - name: "UI Shell"
      type: "spoke"
      description: "Read-only lifecycle view"
    - name: "Audit Log"
      type: "event"
      description: "Immutable lifecycle history"

guard_rails:
  - type: "validation"
    name: "Duplicate Company Creation"
    action: "reject"
  - type: "validation"
    name: "Multiple Active Sub-Hubs"
    action: "reject"
  - type: "validation"
    name: "Invalid Promotion Order"
    action: "reject"
  - type: "validation"
    name: "Unauthorized Promotion"
    action: "reject"

kill_switch:
  endpoint: "/cl/kill-switch"
  activation_criteria: "Invalid lifecycle mutation detected"
  emergency_contact: "SHQ / Barton Ops"

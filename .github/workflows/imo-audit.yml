# IMO Audit CI Gate
#
# DOCTRINE: This workflow is NON-NEGOTIABLE.
# - No allow-failure
# - No manual override
# - One red X blocks merge
#
# Source of Truth: Neon (schema), Doctrine Docs (intent)
# Authority: CONSTITUTIONAL

name: IMO Audit Gate

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

# Prevent concurrent audit runs on same ref
concurrency:
  group: imo-audit-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  imo-audit:
    name: IMO Compliance Audit
    runs-on: ubuntu-latest

    # DOCTRINE: No continue-on-error. Failures block.

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Install Doppler CLI
        uses: dopplerhq/cli-action@v3

      - name: Verify Doctrine Files Exist
        id: doctrine-check
        run: |
          echo "Checking required doctrine files..."

          MISSING=""

          # Core doctrine files
          [ ! -f "CLAUDE.md" ] && MISSING="$MISSING CLAUDE.md"
          [ ! -f "CONSTITUTION.md" ] && MISSING="$MISSING CONSTITUTION.md"
          [ ! -f "IMO_CONTROL.json" ] && MISSING="$MISSING IMO_CONTROL.json"

          # Schema documentation
          [ ! -f "docs/schema/CL_COMPANY_IDENTITY.md" ] && MISSING="$MISSING docs/schema/CL_COMPANY_IDENTITY.md"
          [ ! -f "docs/schema/CL_SCHEMA_INDEX.md" ] && MISSING="$MISSING docs/schema/CL_SCHEMA_INDEX.md"

          # Pipeline documentation
          [ ! -f "docs/operations/PIPELINE_SCRIPTS_REVIEW.md" ] && MISSING="$MISSING docs/operations/PIPELINE_SCRIPTS_REVIEW.md"

          # Contract hash
          [ ! -f "docs/audit/CONTRACT_HASH.json" ] && MISSING="$MISSING docs/audit/CONTRACT_HASH.json"

          if [ -n "$MISSING" ]; then
            echo "FAIL: Missing doctrine files:$MISSING"
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "missing=$MISSING" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "PASS: All doctrine files present"
          echo "status=PASS" >> $GITHUB_OUTPUT

      - name: Verify Doctrine Lock Status
        id: lock-check
        run: |
          echo "Checking doctrine lock status..."

          # Check PIPELINE_SCRIPTS_REVIEW.md for DOCTRINE LOCKED
          if ! grep -q "DOCTRINE LOCKED" docs/operations/PIPELINE_SCRIPTS_REVIEW.md; then
            echo "FAIL: Pipeline docs not doctrine-locked"
            exit 1
          fi

          # Check CL_COMPANY_IDENTITY_BRIDGE.md for DOCTRINE LOCKED
          if ! grep -q "DOCTRINE LOCKED" docs/schema/CL_COMPANY_IDENTITY_BRIDGE.md; then
            echo "FAIL: Bridge docs not doctrine-locked"
            exit 1
          fi

          echo "PASS: All required docs are doctrine-locked"

      - name: Generate Contract Hash
        id: generate-hash
        env:
          DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
        run: |
          echo "Generating contract hash from current state..."
          doppler run -- node scripts/generate_contract_hash.cjs --verify

          if [ $? -ne 0 ]; then
            echo "FAIL: Contract hash generation failed"
            exit 1
          fi

      - name: Verify Contract Hash
        id: hash-verify
        run: |
          echo "Comparing generated hash to committed hash..."

          # Extract hashes
          COMMITTED_SCHEMA=$(jq -r '.schema_hash' docs/audit/CONTRACT_HASH.json)
          COMMITTED_INTENT=$(jq -r '.pipeline_intent_hash' docs/audit/CONTRACT_HASH.json)
          GENERATED_SCHEMA=$(jq -r '.schema_hash' /tmp/CONTRACT_HASH_VERIFY.json)
          GENERATED_INTENT=$(jq -r '.pipeline_intent_hash' /tmp/CONTRACT_HASH_VERIFY.json)

          DRIFT=""

          if [ "$COMMITTED_SCHEMA" != "$GENERATED_SCHEMA" ]; then
            echo "SCHEMA DRIFT DETECTED"
            echo "  Committed: $COMMITTED_SCHEMA"
            echo "  Generated: $GENERATED_SCHEMA"
            DRIFT="schema"
          fi

          if [ "$COMMITTED_INTENT" != "$GENERATED_INTENT" ]; then
            echo "PIPELINE INTENT DRIFT DETECTED"
            echo "  Committed: $COMMITTED_INTENT"
            echo "  Generated: $GENERATED_INTENT"
            DRIFT="$DRIFT intent"
          fi

          if [ -n "$DRIFT" ]; then
            echo ""
            echo "========================================"
            echo "FAIL: CONTRACT HASH MISMATCH"
            echo "========================================"
            echo "Drift detected in: $DRIFT"
            echo ""
            echo "This means schema or pipeline intent changed"
            echo "without updating the contract hash."
            echo ""
            echo "Required action:"
            echo "  1. Review changes for doctrine compliance"
            echo "  2. Re-run: node scripts/generate_contract_hash.cjs"
            echo "  3. Commit updated CONTRACT_HASH.json"
            echo "========================================"
            exit 1
          fi

          echo "PASS: Contract hashes match"

      - name: Verify No Forbidden Patterns
        id: pattern-check
        run: |
          echo "Checking for forbidden patterns..."

          VIOLATIONS=""

          # Check for hardcoded connection strings
          if grep -r "postgresql://" scripts/ --include="*.cjs" --include="*.js" | grep -v "process.env"; then
            VIOLATIONS="$VIOLATIONS hardcoded-connection-string"
          fi

          # Check for forbidden directory structures
          [ -d "src/utils" ] && VIOLATIONS="$VIOLATIONS src/utils/"
          [ -d "src/helpers" ] && VIOLATIONS="$VIOLATIONS src/helpers/"
          [ -d "src/common" ] && VIOLATIONS="$VIOLATIONS src/common/"

          if [ -n "$VIOLATIONS" ]; then
            echo "FAIL: Forbidden patterns detected:$VIOLATIONS"
            exit 1
          fi

          echo "PASS: No forbidden patterns"

      - name: Upload Audit Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: imo-audit-results
          path: |
            docs/audit/CONTRACT_HASH.json
            /tmp/CONTRACT_HASH_VERIFY.json
          retention-days: 30

      - name: Audit Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "IMO AUDIT SUMMARY"
          echo "========================================"
          echo "Doctrine Files:    ${{ steps.doctrine-check.outputs.status || 'PASS' }}"
          echo "Doctrine Lock:     ${{ steps.lock-check.outcome }}"
          echo "Contract Hash:     ${{ steps.hash-verify.outcome }}"
          echo "Pattern Check:     ${{ steps.pattern-check.outcome }}"
          echo "========================================"
          echo ""

          if [ "${{ job.status }}" == "failure" ]; then
            echo "VERDICT: BLOCKED — DO NOT MERGE"
            echo ""
            echo "Fix all failures before merging."
            echo "No exceptions. No overrides."
          else
            echo "VERDICT: COMPLIANT — MERGE ALLOWED"
          fi

  # DOCTRINE: This job has no dependencies and cannot be skipped
  audit-gate:
    name: Audit Gate (Mandatory)
    runs-on: ubuntu-latest
    needs: imo-audit
    if: always()
    steps:
      - name: Check Audit Result
        run: |
          if [ "${{ needs.imo-audit.result }}" != "success" ]; then
            echo "========================================"
            echo "MERGE BLOCKED"
            echo "========================================"
            echo "IMO Audit failed. This PR cannot be merged."
            echo ""
            echo "There are no exceptions to this rule."
            echo "Fix the issues and push again."
            echo "========================================"
            exit 1
          fi

          echo "Audit passed. Merge allowed."

# IMO Audit CI Gate
#
# DOCTRINE: This workflow is NON-NEGOTIABLE.
# - No allow-failure
# - No manual override
# - One red X blocks merge
#
# Source of Truth: [DATABASE_PLATFORM] (schema), Doctrine Docs (intent)
# Authority: CONSTITUTIONAL
#
# TEMPLATE: Replace all [BRACKET] placeholders with hub-specific values.

name: IMO Audit Gate

on:
  pull_request:
    branches: [main, master]
  push:
    branches: [main, master]

# Prevent concurrent audit runs on same ref
concurrency:
  group: imo-audit-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20'

jobs:
  imo-audit:
    name: IMO Compliance Audit
    runs-on: ubuntu-latest

    # DOCTRINE: No continue-on-error. Failures block.

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      # [OPTIONAL: Add secrets provider CLI setup here]
      # - name: Install Doppler CLI
      #   uses: dopplerhq/cli-action@v3

      - name: Verify Doctrine Files Exist
        id: doctrine-check
        run: |
          echo "Checking required doctrine files..."

          MISSING=""

          # Core governance files (GUARDSPEC-required)
          [ ! -f "CLAUDE.md" ] && MISSING="$MISSING CLAUDE.md"
          [ ! -f "CONSTITUTION.md" ] && MISSING="$MISSING CONSTITUTION.md"
          [ ! -f "IMO_CONTROL.json" ] && MISSING="$MISSING IMO_CONTROL.json"
          [ ! -f "REGISTRY.yaml" ] && MISSING="$MISSING REGISTRY.yaml"
          [ ! -f "DOCTRINE.md" ] && MISSING="$MISSING DOCTRINE.md"
          [ ! -f "doctrine/REPO_DOMAIN_SPEC.md" ] && MISSING="$MISSING doctrine/REPO_DOMAIN_SPEC.md"

          # [HUB_SPECIFIC_DOCTRINE_FILES — Add hub-specific required files]
          # [ ! -f "[FILE_PATH]" ] && MISSING="$MISSING [FILE_PATH]"

          if [ -n "$MISSING" ]; then
            echo "FAIL: Missing doctrine files:$MISSING"
            echo "status=FAIL" >> $GITHUB_OUTPUT
            echo "missing=$MISSING" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "PASS: All doctrine files present"
          echo "status=PASS" >> $GITHUB_OUTPUT

      - name: Verify Doctrine Lock Status
        id: lock-check
        run: |
          echo "Checking doctrine lock status..."

          # [LOCKED_DOC_FILES — Check each locked doc for "DOCTRINE LOCKED" marker]
          # if ! grep -q "DOCTRINE LOCKED" [FILE_PATH]; then
          #   echo "FAIL: [FILE_NAME] not doctrine-locked"
          #   exit 1
          # fi

          echo "PASS: All required docs are doctrine-locked"

      # [OPTIONAL: Contract hash verification]
      # - name: Generate Contract Hash
      #   id: generate-hash
      #   env:
      #     DOPPLER_TOKEN: ${{ secrets.DOPPLER_TOKEN }}
      #   run: |
      #     echo "Generating contract hash from current state..."
      #     [SECRETS_PROVIDER] run -- node [HASH_SCRIPT_PATH] --verify

      # - name: Verify Contract Hash
      #   id: hash-verify
      #   run: |
      #     echo "Comparing generated hash to committed hash..."
      #     [HASH_COMPARISON_LOGIC]

      - name: Verify No Forbidden Patterns
        id: pattern-check
        run: |
          echo "Checking for forbidden patterns..."

          VIOLATIONS=""

          # Forbidden directories (GUARDSPEC 3.1)
          [ -d "src/utils" ] && VIOLATIONS="$VIOLATIONS src/utils/"
          [ -d "src/helpers" ] && VIOLATIONS="$VIOLATIONS src/helpers/"
          [ -d "src/common" ] && VIOLATIONS="$VIOLATIONS src/common/"
          [ -d "src/shared" ] && VIOLATIONS="$VIOLATIONS src/shared/"
          [ -d "src/lib" ] && VIOLATIONS="$VIOLATIONS src/lib/"
          [ -d "src/misc" ] && VIOLATIONS="$VIOLATIONS src/misc/"

          # [HUB_SPECIFIC_FORBIDDEN_PATTERNS]
          # Check for hardcoded connection strings, etc.

          if [ -n "$VIOLATIONS" ]; then
            echo "FAIL: Forbidden patterns detected:$VIOLATIONS"
            exit 1
          fi

          echo "PASS: No forbidden patterns"

      - name: Upload Audit Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: imo-audit-results
          path: |
            docs/audit/
          retention-days: 30

      - name: Audit Summary
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "IMO AUDIT SUMMARY"
          echo "========================================"
          echo "Doctrine Files:    ${{ steps.doctrine-check.outputs.status || 'PASS' }}"
          echo "Doctrine Lock:     ${{ steps.lock-check.outcome }}"
          echo "Pattern Check:     ${{ steps.pattern-check.outcome }}"
          echo "========================================"
          echo ""

          if [ "${{ job.status }}" == "failure" ]; then
            echo "VERDICT: BLOCKED — DO NOT MERGE"
            echo "Fix all failures before merging."
            echo "No exceptions. No overrides."
          else
            echo "VERDICT: COMPLIANT — MERGE ALLOWED"
          fi

  # DOCTRINE: This job has no dependencies and cannot be skipped
  audit-gate:
    name: Audit Gate (Mandatory)
    runs-on: ubuntu-latest
    needs: imo-audit
    if: always()
    steps:
      - name: Check Audit Result
        run: |
          if [ "${{ needs.imo-audit.result }}" != "success" ]; then
            echo "========================================"
            echo "MERGE BLOCKED"
            echo "========================================"
            echo "IMO Audit failed. This PR cannot be merged."
            echo "There are no exceptions to this rule."
            echo "Fix the issues and push again."
            echo "========================================"
            exit 1
          fi

          echo "Audit passed. Merge allowed."
